# 📊 相关性分析工具 - Streamlit 前端

这是一个基于 Streamlit 的相关性分析工具前端界面，使用 MCP (Model Context Protocol) 架构调用后端分析服务。

## 🚀 快速开始

### 1. 启动 MCP 服务器

首先确保相关性分析 MCP 服务器正在运行：

```bash
# 在一个终端中启动 MCP 服务器
cd analysis-agent/server
python corr.py
```

服务器将在 `http://localhost:8000` 启动。

### 2. 启动 Streamlit 应用

```bash
# 使用启动脚本（推荐）
./run_streamlit.sh

# 或者手动启动
uv run streamlit run streamlit_app.py --server.port 8501
```

应用将在 `http://localhost:8501` 启动。

## 📋 功能特性

### 🔧 核心功能

- **数据读取**：支持 CSV、Excel 文件上传或路径输入
- **智能列名映射**：自动将用户输入的简化列名映射到实际数据列名
- **相关性分析**：计算两个变量之间的皮尔逊相关系数
- **分组分析**：按指定变量分组计算相关性
- **数据过滤**：根据条件过滤数据子集
- **重试机制**：自动处理 JSON 解析错误，最多重试 3 次

### 📊 可视化功能

- **结果概览**：显示分析统计信息和相关性分布直方图
- **详细数据表格**：可排序、可下载的结果表格
- **交互式图表**：
  - 相关性系数条形图/散点图
  - 相关性强度分类饼图
- **Markdown 报告**：格式化的分析报告，支持下载

### 💾 导出功能

- CSV 格式结果下载
- Markdown 格式报告下载

## 🎯 使用指南

### 1. 配置数据源

**方式一：文件上传**
- 在侧边栏选择"上传文件"
- 支持 CSV、Excel 格式
- 文件会自动保存到临时目录

**方式二：文件路径**
- 在侧边栏选择"输入文件路径"
- 输入完整的文件路径
- 默认路径：`./data/corr.csv`

### 2. 设置分析参数

**相关性变量**
- 输入两个变量名，用逗号分隔
- 例如：`气温,风速` 或 `temperature,humidity`
- 支持智能列名映射（如"气温"会自动映射到"气温(℃)"）

**分组变量（可选）**
- 按指定变量分组计算相关性
- 例如：`站点名称` 会按不同站点分别计算相关性
- 支持多个分组变量，用逗号分隔

**过滤条件（可选）**
- 启用过滤条件复选框
- 输入过滤变量名和值
- 例如：变量名 `站点名称`，值 `高新科技工业园`

### 3. 执行分析

- 点击"🔍 开始分析"按钮
- 系统会验证配置参数
- 分析过程中显示进度指示器
- 结果会保存在会话状态中

### 4. 查看结果

**📈 结果概览**
- 分析组数、平均相关性、最大/最小相关性
- 相关性系数分布直方图

**📋 详细数据**
- 完整的结果表格
- 支持 CSV 下载

**📊 可视化**
- 相关性系数图表
- 相关性强度分类（强相关、中等相关、弱相关、几乎无关）

**📄 Markdown 报告**
- 格式化的分析报告
- 支持 Markdown 下载

## 🔧 技术架构

```
┌─────────────────┐    HTTP/SSE    ┌─────────────────┐
│  Streamlit App  │ ──────────────► │   MCP Server    │
│   (Frontend)    │                │   (Backend)     │
└─────────────────┘                └─────────────────┘
         │                                   │
         │                                   │
         ▼                                   ▼
┌─────────────────┐                ┌─────────────────┐
│   User Files    │                │  Column Mapping │
│   (CSV/Excel)   │                │     Agent       │
└─────────────────┘                └─────────────────┘
```

### 组件说明

- **Streamlit App**：用户界面，处理交互和可视化
- **MCP Server**：后端分析服务，处理数据和计算
- **Column Mapping Agent**：智能列名映射，使用 LLM 进行语义匹配

## 📝 示例用法

### 示例 1：基础相关性分析

```
数据源：./data/corr.csv
相关性变量：气温,风速
分组变量：无
过滤条件：无
```

结果：计算整个数据集中气温和风速的相关性。

### 示例 2：分组相关性分析

```
数据源：./data/corr.csv
相关性变量：气温,PM2.5
分组变量：站点名称
过滤条件：无
```

结果：按不同监测站点分别计算气温和 PM2.5 的相关性。

### 示例 3：过滤条件分析

```
数据源：./data/corr.csv
相关性变量：气温,风速
分组变量：无
过滤条件：站点名称 = 高新科技工业园
```

结果：仅分析特定站点的气温和风速相关性。

## ⚠️ 注意事项

1. **数据格式**：确保数据文件格式正确，数值列不包含非数字字符
2. **列名映射**：系统会自动映射列名，但建议使用准确的列名
3. **数据量**：大数据集可能需要较长处理时间
4. **网络连接**：确保 MCP 服务器可访问
5. **浏览器兼容性**：推荐使用现代浏览器（Chrome、Firefox、Safari）

## 🐛 故障排除

### 常见问题

**问题 1：无法连接到 MCP 服务器**
- 检查 MCP 服务器是否在 `http://localhost:8000` 运行
- 确认防火墙设置允许本地连接

**问题 2：列名映射失败**
- 检查输入的变量名是否与数据列名相似
- 系统会自动重试，如果 3 次都失败会显示错误信息

**问题 3：数据类型错误**
- 确保相关性变量是数值型
- 系统会自动清理非数值数据

**问题 4：文件上传失败**
- 检查文件格式是否支持（CSV、Excel）
- 确认文件大小不超过限制

## 📞 技术支持

如遇到问题，请检查：
1. 控制台错误信息
2. MCP 服务器日志
3. Streamlit 应用日志

---

**版本**：1.0.0  
**更新时间**：2025-05-27  
**技术栈**：Streamlit + MCP + Plotly + Pandas 